<!DOCTYPE html>
<html>
<head>
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- _includes/base.html -->

    <link rel="canonical" href="http://localhost:4000..//2018-03-05-to-do/" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="../page2/" />

    <meta property="og:site_name" content="Finding The Way Smarter" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="I Have a To Do" />
    <meta property="og:description" content="做一个谦卑，忠诚的实践者，不要做一个严谨，深沉的思想家. The story begins here." />
    <meta property="og:url" content="http://localhost:4000..//2018-03-05-to-do/" />
    <meta property="og:image" content="../assets/images/cover4.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="I Have a To Do" />
    <meta name="twitter:description" content="做一个谦卑，忠诚的实践者，不要做一个严谨，深沉的思想家. The story begins here." />
    <meta name="twitter:url" content="http://localhost:4000..//2018-03-05-to-do/" />
    <meta name="twitter:image:src" content="../assets/images/cover4.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Finding The Way Smarter",
    "name": "I Have a To Do",
    "url": "http://localhost:4000..//2018-03-05-to-do/",
    "image": "../assets/images/cover4.jpg",
    "description": "做一个谦卑，忠诚的实践者，不要做一个严谨，深沉的思想家. The story begins here."
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Finding The Way Smarter" href="feed.xml" />

    <!-- Page Meta -->
    <title>I Have a To Do</title>
    <meta name="description" content="做一个谦卑，忠诚的实践者，不要做一个严谨，深沉的思想家. The story begins here." />

    <!-- Mobile Meta -->
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Brand icon -->
    <link rel="shortcut icon" href="../assets/images/favicon.ico" >

    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="../assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
  
    <link class="codestyle" href="../assets/css/mono-blue.css" rel="stylesheet">

    <style>.hljs { background: none; }</style>

    <!-- Ghost outputs important style and meta data with this tag -->
    

</head>
<body class="home-template nav-closed">

    <!-- The blog navigation links -->
    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="../">Home</a></li>
        <li class="nav-about " role="presentation"><a href="../about">About</a></li>
        <li class="nav-fables " role="presentation"><a href="../tag/fables">Fables</a></li>
        <li class="nav-speeches " role="presentation"><a href="../tag/speeches">Speeches</a></li>
        <li class="nav-fiction " role="presentation"><a href="../tag/fiction">Fiction</a></li>
        <li class="nav-author " role="presentation"><a href="../author/casper">Casper</a></li>
        <li class="nav-author " role="presentation"><a href="../author/edgar">Edgar</a></li>
        <li class="nav-author " role="presentation"><a href="../author/abraham">Abraham</a></li>
        <li class="nav-author " role="presentation"><a href="../author/martin">Martin</a></li>
        <li class="nav-author " role="presentation"><a
                href="../author/kidlovec">kidlovec</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="../feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

    <!-- _includes/base.html -->

    <link rel="canonical" href="http://localhost:4000..//2018-03-05-to-do/" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="../page2/" />

    <meta property="og:site_name" content="Finding The Way Smarter" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="I Have a To Do" />
    <meta property="og:description" content="做一个谦卑，忠诚的实践者，不要做一个严谨，深沉的思想家. The story begins here." />
    <meta property="og:url" content="http://localhost:4000..//2018-03-05-to-do/" />
    <meta property="og:image" content="../assets/images/cover4.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="I Have a To Do" />
    <meta name="twitter:description" content="做一个谦卑，忠诚的实践者，不要做一个严谨，深沉的思想家. The story begins here." />
    <meta name="twitter:url" content="http://localhost:4000..//2018-03-05-to-do/" />
    <meta name="twitter:image:src" content="../assets/images/cover4.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Finding The Way Smarter",
    "name": "I Have a To Do",
    "url": "http://localhost:4000..//2018-03-05-to-do/",
    "image": "../assets/images/cover4.jpg",
    "description": "做一个谦卑，忠诚的实践者，不要做一个严谨，深沉的思想家. The story begins here."
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Finding The Way Smarter" href="feed.xml" />

<header class="main-header post-head " style="background-image: url(../assets/images/cover4.jpg) ">
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="../"><img src="../assets/images/ghost.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-speeches design-pattern">

        <header class="post-header">
            <h1 class="post-title">I Have a To Do</h1>
            <section class="post-meta">
            <!-- <a href='../'></a> -->

            
                
            
                
            
                
            
                
            
                
                    <a href='../author/kidlovec'>浪心</a>
                
            
                
            
            <time class="post-date" datetime="2018-03-05">05 Mar 2018</time>
                <!-- [[tags prefix=" on "]] -->
                
                on
                
                    
                       <a href='../tag/design'>Design</a>
                    
                
                
            </section>
        </header>

        <section class="post-content">

            <h1 id="目录">目录</h1>

<ul>
  <li><a href="#param-and-attribute">param and attribute</a></li>
  <li><a href="#to-do-list">Get the things done</a></li>
</ul>

<hr />

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">def foo
  puts &#39;foo&#39;
end</code></pre></figure>

<hr />

<p>入职手续准备
遗留问题研究</p>

<p>敬慎</p>
<ul>
  <li>高而能下，</li>
  <li>满而能虚，</li>
  <li>富而能俭，</li>
  <li>贵而能卑，</li>
  <li>智而能愚，</li>
  <li>勇而能怯，</li>
  <li>辩而能讷，</li>
  <li>博而能浅，</li>
  <li>明而能闇，</li>
  <li>是谓损而不极。</li>
  <li>能行此道，唯至德者及之。</li>
</ul>

<h3 id="各种集合的-遍历性能对比">各种集合的 遍历性能对比</h3>

<p>可以在 github 上 开一个
先想想怎么测试</p>

<ul>
  <li>数据量
    <ul>
      <li>基本类型</li>
      <li>对象</li>
      <li>大对象</li>
    </ul>
  </li>
  <li>测试对象
    <ul>
      <li>list
        <ul>
          <li>arrayList</li>
          <li>linkedList</li>
          <li></li>
        </ul>
      </li>
      <li>map</li>
      <li>set</li>
      <li>vector</li>
    </ul>
  </li>
</ul>

<h3 id="to-do-listdo-to-list">to do list(do to list)</h3>
<ul>
  <li>spring 画面验证
    <ul>
      <li>Valid</li>
      <li>Validated 区别验证</li>
    </ul>
  </li>
  <li>
    <p>Annotation 会覆盖嘛？</p>
  </li>
  <li>db
    <ul>
      <li>redis</li>
      <li>mybatis generator</li>
      <li>mybatis 二级缓存</li>
    </ul>
  </li>
</ul>

<h3 id="异常处理最佳实践">异常处理最佳实践</h3>
<p><code>根据我的工作经历来看，我主要遵循以下几点：</code>
    1. 尽量不要在代码中写try…catch.finally把异常吃掉。
    2. 异常要尽量直观，防止被他人误解
    3. 将异常分为以下几类,业务异常，登录状态无效异常，（虽已登录，且状态有效）未授权异常，系统异常（JDK中定义Error和Exception，比如NullPointerException, ArithmeticException 和 InputMismatchException）
    4. 可以在某个特定的Controller中处理异常，也可以使用全局异常处理器。尽量使用全局异常处理器</p>

<ul>
  <li>spring
    <ul>
      <li>controller</li>
      <li>validator</li>
      <li>command</li>
      <li>form</li>
      <li>model</li>
      <li>dispatcherServlet</li>
      <li>handler mapping</li>
      <li>view resolver</li>
    </ul>
  </li>
</ul>

<hr />

<p>WebApplicationContext</p>

<table>
  <thead>
    <tr>
      <th>No</th>
      <th>Bean Type</th>
      <th>Explanation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>HandlerMapping</td>
      <td>Maps incoming requests to handlers and a list of pre- and post-processors (handler interceptors) based on some criteria the details of which vary by HandlerMapping implementation. The most popular implementation supports annotated controllers but other implementations exists as well.</td>
    </tr>
    <tr>
      <td>2</td>
      <td>HandlerAdapter</td>
      <td>Helps the DispatcherServlet to invoke a handler mapped to a request regardless of the handler is actually invoked. For example, invoking an annotated controller requires resolving various annotations. Thus the main purpose of a HandlerAdapter is to shield the DispatcherServlet from such details.</td>
    </tr>
    <tr>
      <td>3</td>
      <td>HandlerExceptionResolver</td>
      <td>Maps exceptions to views also allowing for more complex exception handling code.</td>
    </tr>
    <tr>
      <td>4</td>
      <td>ViewResolver</td>
      <td>Resolves logical String-based view names to actual View types.</td>
    </tr>
    <tr>
      <td>5</td>
      <td>LocaleResolver &amp; LocaleContextResolver</td>
      <td>Resolves the locale a client is using and possibly their time zone, in order to be able to offer internationalized views</td>
    </tr>
    <tr>
      <td>6</td>
      <td>ThemeResolver</td>
      <td>Resolves themes your web application can use, for example, to offer personalized layouts</td>
    </tr>
    <tr>
      <td>7</td>
      <td>MultipartResolver</td>
      <td>Parses multi-part requests for example to support processing file uploads from HTML forms.</td>
    </tr>
    <tr>
      <td>8</td>
      <td>FlashMapManager</td>
      <td>Stores and retrieves the “input” and the “output” FlashMap that can be used to pass attributes from one request to another, usually across a redirect.</td>
    </tr>
  </tbody>
</table>

<hr />

<h3 id="request-中-parameter-与-attribute-的区别param-and-attribute">request 中 parameter 与 attribute 的区别(param and attribute)</h3>
<ul>
  <li>不同点
    <ul>
      <li>来源：param 为 客户端发送给服务端的参数 而 attribute 是服务端设置的 属性</li>
      <li>操作：param 只能读取，不能设置，而 attribute 能够被读写</li>
      <li>类型：param 作为参数，放在 get 方式的 url 中 post 方式的 request body 中，在服务端获取的时候，都会被当做 string 看待, 而 attribute 则可以存储任意的 object 对象</li>
    </ul>
  </li>
  <li>共同点
    <ul>
      <li>二者的值都被封装在request对象中。</li>
    </ul>
  </li>
</ul>

<h3 id="异常处理最佳实践-1">异常处理最佳实践</h3>

<h3 id="登陆">登陆</h3>

<h3 id="行程计划">行程计划</h3>

<ul>
  <li>插入</li>
  <li>更新</li>
  <li>查询</li>
  <li>分页</li>
  <li>流水记录</li>
  <li>流水查询</li>
  <li>流水能更新</li>
  <li>流水设计</li>
  <li>流水插入时点</li>
  <li>行程计划和流水查询的相关功能点， 哪里需要拉计划和流水，找出来</li>
</ul>

<h4 id="ide运行">IDE运行</h4>

<p>因为程序本身按照Docker启动，所以对于hostname需要在hosts文件中设置正确才能正常运行：</p>

<pre><code class="language-shell">## solar
127.0.0.1 eureka1
127.0.0.1 eureka2
127.0.0.1 rabbitmq
127.0.0.1 zipkin_server
127.0.0.1 solar_mysql
127.0.0.1 gitlab
</code></pre>

<p>根据依赖关系，程序最好按照以下的顺序执行</p>

<p>docker mysql &gt; docker rabbitmq &gt; eureka server &gt; config server &gt; zipkin server &gt; 其他业务微服务（account-ms, product-ms, order-ms, tcc-coordinator-ms等）</p>

<h2 id="示例">示例</h2>

<p>根据附表中的服务字典，我们通过Zuul或Swagge对<code>order</code>服务进行预订单生成操作。</p>

<pre><code class="language-http">POST http://localhost:7291/order/api/v1/orders
Content-Type: application/json;charset=UTF-8

{
  "product_id": 7,
  "user_id": 1
}
</code></pre>

<p>成功后我们将得到预订单的结果</p>

<pre><code class="language-json">{
  "data": {
    "id": 15,
    "create_time": "2017-03-28T18:18:02.206+08:00",
    "update_time": "1970-01-01T00:00:00+08:00",
    "delete_time": "1970-01-01T00:00:00+08:00",
    "user_id": 1,
    "product_id": 7,
    "price": 14,
    "status": "PROCESSING"
  },
  "code": 20000
}
</code></pre>

<p>此时我们再确认订单</p>

<p>(如果想测试预留资源的补偿情况，那么就等15s后过期再发请求，注意容器与宿主机的时间)</p>

<pre><code>POST http://localhost:7291/order/api/v1/orders/confirmation
Content-Type: application/json;charset=UTF-8

{
  "order_id": 15
}
</code></pre>

<p>如果成功确认则返回如下结果</p>

<pre><code class="language-json">{
  "data": {
    "id": 15,
    "create_time": "2017-03-28T18:18:02.206+08:00",
    "update_time": "2017-03-28T18:21:32.78+08:00",
    "delete_time": "1970-01-01T00:00:00+08:00",
    "user_id": 1,
    "product_id": 7,
    "price": 14,
    "status": "DONE"
  },
  "code": 20000
}
</code></pre>

<pre><code class="language-java">public class RPCProtocol implements Protocol {
	
	public static final int TYPE = 1;
	
	private static final Log LOGGER = LogFactory.getLog(RPCProtocol.class);
	
	private static final int REQUEST_HEADER_LEN = 1 * 6 + 5 * 4;
	
	private static final int RESPONSE_HEADER_LEN = 1 * 6 + 3 * 4;
	
	private static final byte VERSION = (byte)1;
	
	private static final byte REQUEST = (byte)0;
	
	private static final byte RESPONSE = (byte)1;
	
	@Override
	public ByteBufferWrapper encode(Object message, ByteBufferWrapper bytebufferWrapper) throws Exception{
		if(!(message instanceof RequestWrapper) &amp;&amp; !(message instanceof ResponseWrapper)){
			throw new Exception("only support send RequestWrapper &amp;&amp; ResponseWrapper");
		}
		int id = 0;
		byte type = REQUEST;
		if(message instanceof RequestWrapper){
			try{
				int requestArgTypesLen = 0;
				int requestArgsLen = 0;
				List&lt;byte[]&gt; requestArgTypes = new ArrayList&lt;byte[]&gt;();
				List&lt;byte[]&gt; requestArgs = new ArrayList&lt;byte[]&gt;();
				RequestWrapper wrapper = (RequestWrapper) message;
				byte[][] requestArgTypeStrings = wrapper.getArgTypes();
				for (byte[] requestArgType : requestArgTypeStrings) {
					requestArgTypes.add(requestArgType);
					requestArgTypesLen += requestArgType.length;
				}
				Object[] requestObjects = wrapper.getRequestObjects();
				if(requestObjects!=null){
					for (Object requestArg : requestObjects) {
						byte[] requestArgByte = Codecs.getEncoder(wrapper.getCodecType()).encode(requestArg);
						requestArgs.add(requestArgByte);
						requestArgsLen += requestArgByte.length;
					}
				}
				byte[] targetInstanceNameByte = wrapper.getTargetInstanceName();
				byte[] methodNameByte = wrapper.getMethodName();
				id = wrapper.getId();
				int timeout = wrapper.getTimeout();
				int capacity = ProtocolUtils.HEADER_LEN + REQUEST_HEADER_LEN + requestArgs.size() * 4 * 2 + targetInstanceNameByte.length 
							   + methodNameByte.length + requestArgTypesLen + requestArgsLen;
				ByteBufferWrapper byteBuffer = bytebufferWrapper.get(capacity);
				byteBuffer.writeByte(ProtocolUtils.CURRENT_VERSION);
				byteBuffer.writeByte((byte)TYPE);
				byteBuffer.writeByte(VERSION);
				byteBuffer.writeByte(type);
				byteBuffer.writeByte((byte)wrapper.getCodecType());
				byteBuffer.writeByte((byte)0);
				byteBuffer.writeByte((byte)0);
				byteBuffer.writeByte((byte)0);
				byteBuffer.writeInt(id);
				byteBuffer.writeInt(timeout);
				byteBuffer.writeInt(targetInstanceNameByte.length);
				byteBuffer.writeInt(methodNameByte.length);
				byteBuffer.writeInt(requestArgs.size());
				for (byte[] requestArgType : requestArgTypes) {
					byteBuffer.writeInt(requestArgType.length);
				}
				for (byte[] requestArg : requestArgs) {
					byteBuffer.writeInt(requestArg.length);
				}
				byteBuffer.writeBytes(targetInstanceNameByte);
				byteBuffer.writeBytes(methodNameByte);
				for (byte[] requestArgType : requestArgTypes) {
					byteBuffer.writeBytes(requestArgType);
				}
				for (byte[] requestArg : requestArgs) {
					byteBuffer.writeBytes(requestArg);
				}
				return byteBuffer;
			}
			catch(Exception e){
				LOGGER.error("encode request object error",e);
				throw e;
			}
		}
		else{
			ResponseWrapper wrapper = (ResponseWrapper) message;
			byte[] body = new byte[0];
			byte[] className = new byte[0];
			try{
				// no return object
				if(wrapper.getResponse() != null){
					className = wrapper.getResponse().getClass().getName().getBytes();
					body = Codecs.getEncoder(wrapper.getCodecType()).encode(wrapper.getResponse());
				}
				if(wrapper.isError()){
					className = wrapper.getException().getClass().getName().getBytes();
					body = Codecs.getEncoder(wrapper.getCodecType()).encode(wrapper.getException());
				}
				id = wrapper.getRequestId();
			}
			catch(Exception e){
				LOGGER.error("encode response object error", e);
				// still create responsewrapper,so client can get exception
				wrapper.setResponse(new Exception("serialize response object error",e));
				className = Exception.class.getName().getBytes();
				body = Codecs.getEncoder(wrapper.getCodecType()).encode(wrapper.getResponse());
			}
			type = RESPONSE;
			int capacity = ProtocolUtils.HEADER_LEN + RESPONSE_HEADER_LEN + body.length;
			if(wrapper.getCodecType() == Codecs.PB_CODEC){
				capacity += className.length;
			}
			ByteBufferWrapper byteBuffer = bytebufferWrapper.get(capacity);
			byteBuffer.writeByte(ProtocolUtils.CURRENT_VERSION);
			byteBuffer.writeByte((byte)TYPE);
			byteBuffer.writeByte(VERSION);
			byteBuffer.writeByte(type);
			byteBuffer.writeByte((byte)wrapper.getCodecType());
			byteBuffer.writeByte((byte)0);
			byteBuffer.writeByte((byte)0);
			byteBuffer.writeByte((byte)0);
			byteBuffer.writeInt(id);
			if(wrapper.getCodecType() == Codecs.PB_CODEC){
				byteBuffer.writeInt(className.length);
			}
			else{
				byteBuffer.writeInt(0);
			}
			byteBuffer.writeInt(body.length);
			if(wrapper.getCodecType() == Codecs.PB_CODEC){
				byteBuffer.writeBytes(className);
			}
			byteBuffer.writeBytes(body);
			return byteBuffer;
		}
	}
	
	public Object decode(ByteBufferWrapper wrapper,Object errorObject,int...originPosArray) throws Exception{
		final int originPos;
		if(originPosArray!=null &amp;&amp; originPosArray.length == 1){
			originPos = originPosArray[0];
		}
		else{
			originPos = wrapper.readerIndex();
		}
		if(wrapper.readableBytes() &lt; 2){
			wrapper.setReaderIndex(originPos);
        	return errorObject;
        }
        byte version = wrapper.readByte();
        if(version == (byte)1){
        	byte type = wrapper.readByte();
        	if(type == REQUEST){
        		if(wrapper.readableBytes() &lt; REQUEST_HEADER_LEN -2){
        			wrapper.setReaderIndex(originPos);
        			return errorObject;
        		}
        		int codecType = wrapper.readByte();
        		wrapper.readByte();
        		wrapper.readByte();
        		wrapper.readByte();
        		int requestId = wrapper.readInt();
        		int timeout = wrapper.readInt();
        		int targetInstanceLen = wrapper.readInt();
        		int methodNameLen = wrapper.readInt();
        		int argsCount = wrapper.readInt();
        		int argInfosLen = argsCount * 4 * 2;
        		int expectedLenInfoLen = argInfosLen + targetInstanceLen + methodNameLen;
        		if(wrapper.readableBytes() &lt; expectedLenInfoLen){
        			wrapper.setReaderIndex(originPos);
        			return errorObject;
        		}
        		int expectedLen = 0;
        		int[] argsTypeLen = new int[argsCount];
        		for (int i = 0; i &lt; argsCount; i++) {
					argsTypeLen[i] = wrapper.readInt();
					expectedLen += argsTypeLen[i]; 
				}
        		int[] argsLen = new int[argsCount];
        		for (int i = 0; i &lt; argsCount; i++) {
        			argsLen[i] = wrapper.readInt();
        			expectedLen += argsLen[i];
				}
        		byte[] targetInstanceByte = new byte[targetInstanceLen];
        		wrapper.readBytes(targetInstanceByte);
        		byte[] methodNameByte = new byte[methodNameLen];
        		wrapper.readBytes(methodNameByte);
        		if(wrapper.readableBytes() &lt; expectedLen){
        			wrapper.setReaderIndex(originPos);
        			return errorObject;
        		}
        		byte[][] argTypes = new byte[argsCount][];
        		for (int i = 0; i &lt; argsCount; i++) {
					byte[] argTypeByte = new byte[argsTypeLen[i]];
					wrapper.readBytes(argTypeByte);
					argTypes[i] = argTypeByte;
				}
        		Object[] args = new Object[argsCount];
        		for (int i = 0; i &lt; argsCount; i++) {
					byte[] argByte = new byte[argsLen[i]];
					wrapper.readBytes(argByte);
					args[i] = argByte;
				}
        		RequestWrapper requestWrapper = new RequestWrapper(targetInstanceByte, methodNameByte, 
        														   argTypes, args, timeout, requestId, codecType, TYPE);
        		int messageLen = ProtocolUtils.HEADER_LEN + REQUEST_HEADER_LEN + expectedLenInfoLen + expectedLen;
        		requestWrapper.setMessageLen(messageLen);
        		return requestWrapper;
        	}
        	else if(type == RESPONSE){
        		if(wrapper.readableBytes() &lt; RESPONSE_HEADER_LEN -2){
        			wrapper.setReaderIndex(originPos);
        			return errorObject;
        		}
        		int codecType = wrapper.readByte();
        		wrapper.readByte();
        		wrapper.readByte();
        		wrapper.readByte();
            	int requestId = wrapper.readInt();
            	int classNameLen = wrapper.readInt();
            	int bodyLen = wrapper.readInt();
            	if(wrapper.readableBytes() &lt; classNameLen + bodyLen){
            		wrapper.setReaderIndex(originPos);
            		return errorObject;
            	}

            	byte[] classNameBytes = null;
            	if(codecType == Codecs.PB_CODEC){	
	            	classNameBytes = new byte[classNameLen];
	            	wrapper.readBytes(classNameBytes);
            	}
            	byte[] bodyBytes = new byte[bodyLen];
            	wrapper.readBytes(bodyBytes);
            	ResponseWrapper responseWrapper = new ResponseWrapper(requestId,codecType,TYPE);
            	responseWrapper.setResponse(bodyBytes);
            	responseWrapper.setResponseClassName(classNameBytes);
	        	int messageLen = ProtocolUtils.HEADER_LEN + RESPONSE_HEADER_LEN + classNameLen + bodyLen;
	        	responseWrapper.setMessageLen(messageLen);
            	return responseWrapper;
        	}
        	else{
        		throw new UnsupportedOperationException("protocol type : "+type+" is not supported!");
        	}
        }
        else{
        	throw new UnsupportedOperationException("protocol version :"+version+" is not supported!");
        }
	}

}
</code></pre>

<p>至此就完成了一次TCC事务，当然你也可以测试超时和冲突的情况，这里就不再赘述。</p>

<h2 id="拓展">拓展</h2>

<h3 id="使用gitlab作为远程配置仓库">使用Gitlab作为远程配置仓库</h3>

<p>本例中默认使用Github或GitOsc中的公开仓库，出于自定义的需要，我们可以在本地构建Git仓库，这里选用Gitlab为例。</p>

<p>将以下配置添加至docker compose中的文件中并启动Docker Gitlab容器：</p>

<pre><code class="language-yaml">gitlab:
    image: daocloud.io/daocloud/gitlab:8.16.7-ce.0
    ports:
        - "10222:22"
        - "80:80"
        - "10443:443"
    volumes:
        - "./docker-gitlab/config/:/etc/gitlab/"
        - "./docker-gitlab/logs/:/var/log/gitlab/"
        - "./docker-gitlab/data/:/var/opt/gitlab/"
    environment:
        - TZ=Asia/Shanghai
</code></pre>

<p>将项目的<code>config-repo</code>添加至Gitlab中，并修改<code>config-ms</code>中git仓库的相关验证等参数即可。</p>

<p><img src="./../assets/images/cover3.jpg" alt="" /></p>

<h2 id="服务字典">服务字典</h2>

<p>鉴于Spring Boot Actuator的端点所带来的两面性，除了可以增加<code>spring-boot-starter-security</code>来获得强度较弱的HTTP Basic认证外，我们还可以修改<code>management.port</code>和<code>management.context-path</code>来提高攻击成本. 是的，我对每一个服务都修改了以上两个属性，并且兼容了Eureka Server，Hystrix Dashboard，Spring Boot Admin，使这些监控服务仍能正确工作. 因为对以上两个参数修改，我们的监控路径有所变化，如下表：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">module name</th>
      <th style="text-align: center">docker compose service name</th>
      <th style="text-align: center">application name</th>
      <th style="text-align: center">server port</th>
      <th style="text-align: center">management port</th>
      <th style="text-align: center">management context path</th>
      <th style="text-align: center">scalable</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">account-ms</td>
      <td style="text-align: center">account</td>
      <td style="text-align: center">account</td>
      <td style="text-align: center">10014</td>
      <td style="text-align: center">10248</td>
      <td style="text-align: center"><strong>/78d504ff-82e8-4a87-82e8-724d72d1171b</strong></td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">api-gateway-ms</td>
      <td style="text-align: center">gateway</td>
      <td style="text-align: center">gateway</td>
      <td style="text-align: center">7291</td>
      <td style="text-align: center">10211</td>
      <td style="text-align: center">/fb83deee-dd46-472b-99a9-f0ebffe20d0e</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">config-ms</td>
      <td style="text-align: center">config_server</td>
      <td style="text-align: center">config-server</td>
      <td style="text-align: center">10888</td>
      <td style="text-align: center">10481</td>
      <td style="text-align: center">/f7597180-e480-400e-81a0-847c22e2e0b8</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">eureka-registry-ms-1</td>
      <td style="text-align: center">eureka1</td>
      <td style="text-align: center">registry</td>
      <td style="text-align: center">8763</td>
      <td style="text-align: center">9274</td>
      <td style="text-align: center">/55395018-70b7-47c3-8fef-5bf24c9da9af</td>
      <td style="text-align: center">×</td>
    </tr>
    <tr>
      <td style="text-align: center">eureka-registry-ms-2</td>
      <td style="text-align: center">eureka2</td>
      <td style="text-align: center">registry</td>
      <td style="text-align: center">8762</td>
      <td style="text-align: center">10177</td>
      <td style="text-align: center">/e5da837b-a575-4447-b037-100850226a11</td>
      <td style="text-align: center">×</td>
    </tr>
    <tr>
      <td style="text-align: center">hystrix-dashboard-ms</td>
      <td style="text-align: center">hystrix_dashboard</td>
      <td style="text-align: center">hystrix</td>
      <td style="text-align: center">8193</td>
      <td style="text-align: center">7104</td>
      <td style="text-align: center">/9511d89d-6488-4293-8df8-c4feb8681e83</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">membership-ms</td>
      <td style="text-align: center">membership</td>
      <td style="text-align: center">membership</td>
      <td style="text-align: center">10673</td>
      <td style="text-align: center">10391</td>
      <td style="text-align: center">/a6da3b6f-4b59-11e7-9226-0242ac130004</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">order-ms</td>
      <td style="text-align: center">order</td>
      <td style="text-align: center">order</td>
      <td style="text-align: center">8295</td>
      <td style="text-align: center">10848</td>
      <td style="text-align: center"><strong>/78d504ff-82e8-4a87-82e8-724d72d1171b</strong></td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">product-ms</td>
      <td style="text-align: center">product</td>
      <td style="text-align: center">product</td>
      <td style="text-align: center">8040</td>
      <td style="text-align: center">10912</td>
      <td style="text-align: center"><strong>/78d504ff-82e8-4a87-82e8-724d72d1171b</strong></td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">spring-boot-admin-ms</td>
      <td style="text-align: center">spring_boot_admin</td>
      <td style="text-align: center">spring-boot-admin</td>
      <td style="text-align: center">7020</td>
      <td style="text-align: center">9218</td>
      <td style="text-align: center">/e58a0ff5-9f60-4545-9aa2-2b91c8a6d53b</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">tcc-coordinator-ms</td>
      <td style="text-align: center">tcc_coordinator</td>
      <td style="text-align: center">tcc</td>
      <td style="text-align: center">11020</td>
      <td style="text-align: center">12841</td>
      <td style="text-align: center"><strong>/78d504ff-82e8-4a87-82e8-724d72d1171b</strong></td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">zipkin-ms</td>
      <td style="text-align: center">zipkin_server</td>
      <td style="text-align: center">zipkin-server</td>
      <td style="text-align: center">9411</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center">×</td>
    </tr>
  </tbody>
</table>

<h2 id="结语">结语</h2>



        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->
            
                
            
                
            
                
            
                
            
                
                    
                        <figure class="author-image">
                            <a class="img" href="../author/kidlovec" style="background-image: url(../assets/images/lang.xin.400x400.jpeg)"><span class="hidden">kidlovec's Picture</span></a>
                        </figure>
                    

                    <section class="author">
                        <h4><a href="../author/kidlovec">浪心</a></h4>

                        
                            <p> An Chinese coder. focus on java/spring/flink</p>
                        
                        <div class="author-meta">
                            <span class="author-location icon-location"> Shanghai, China</span>
                            <span class="author-link icon-link"><a href="http://kidlovec.github.io/"> kidlovec.github.io/</a></span>
                        </div>
                    </section>

                    <!-- /author  -->

                    <section class="share">
                        <h4>Share this post</h4>
                        <a class="icon-twitter" href="http://twitter.com/share?text=I Have a To Do&amp;url=http://localhost:40002018-03-05-to-do"
                            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                            <span class="hidden">Twitter</span>
                        </a>
                        <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:40002018-03-05-to-do"
                            onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                            <span class="hidden">Facebook</span>
                        </a>
                        <a class="icon-google-plus" href="https://plus.google.com/share?url=http://localhost:40002018-03-05-to-do"
                           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                            <span class="hidden">Google+</span>
                        </a>
                    </section>
                
            
                
            

            <!-- Add Disqus Comments -->
            

        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev "
            style="background-image: url(../assets/images/cover3.jpg)"
            href="../2014-09-27-a-full-and-comprehensive-style-test">
            <section class="post">
                <h2>A Full and Comprehensive Style Test</h2>
                <p>This is just an ipsis verbis copy of the first example running on the Ghost...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <!-- The tiny footer at the very bottom -->
        <footer class="site-footer clearfix">
          <section class="copyright"><a href="../">Finding The Way Smarter</a> &copy; 2020</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/jekyller/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- highlight.js -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- jQuery needs to come before `` so that jQuery can be used in code injection -->
    <script type="text/javascript" src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <!-- Ghost outputs important scripts and data with this tag -->
    <!--  -->
    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', '', 'auto');
	    ga('send', 'pageview');

     </script>
    <!-- Fitvids makes video embeds responsive and awesome -->
    <script type="text/javascript" src="../assets/js/jquery.fitvids.js"></script>
    <!-- The main JavaScript file for Casper -->
    <script type="text/javascript" src="../assets/js/index.js"></script>

</body>
</html>
